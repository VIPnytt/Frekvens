name: Miscellaneous

on:
  merge_group:
    types:
      - checks_requested

  pull_request:
    branches:
      - main

  push:
    branches:
      - main

  workflow_dispatch:

permissions:
  contents: read

jobs:
  platformio:
    name: PlatformIO version extract
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.print.outputs.environments }}
      version: ${{ steps.print.outputs.version }}

    steps:
      - name: Set up Frekvens
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: 3.13
          cache: pip
          cache-dependency-path: .github/platformio/requirements.txt

      - name: Set up PlatformIO
        run: pip install -r .github/platformio/requirements.txt

      - name: PlatformIO extract
        id: print
        run: echo "version=$(pio --version | awk '{print $NF}')" >> "$GITHUB_OUTPUT"

  animation-splitter:
    name: Animation splitter
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - python-version: 3.11
          - python-version: 3.14

    steps:
      - name: Set up Frekvens
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: tools/pyproject.toml

      - name: Set up Frekvens tools
        run: pip install tools/

      - name: Animation splitter
        run: |
          cat <<EOL > Animation.csv
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,255,0,0,0,0,0,255,0,0,255,0,0,0
          0,0,0,255,0,0,0,0,0,0,0,0,255,0,0,0
          0,0,0,255,255,255,0,0,0,255,0,0,255,0,0,0
          0,0,0,255,0,0,255,0,0,255,0,0,255,0,0,0
          0,0,0,255,0,0,255,0,0,255,0,0,0,0,0,0
          0,0,0,255,0,0,255,0,0,255,0,0,255,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,255,255,0,0,0,0,255,255,0,0,0,0
          0,0,0,0,255,255,0,0,0,0,255,255,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,255,255,0,0,0,0,255,255,0,0,0,0
          0,0,0,0,0,255,255,255,255,255,255,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
          EOL

          python -m frekvens.AnimationSplitter -i Animation.csv

      - name: File existence
        uses: andstor/file-existence-action@076e0072799f4942c8bc574a82233e1e4d13e9d6 # v3.0.0
        with:
          fail: true
          files: Animation-1.csv, Animation-2.csv

  home-thermometer-demo:
    name: Home thermometer demo
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - python-version: 3.11
          - python-version: 3.14

    steps:
      - name: Set up Frekvens
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: tools/pyproject.toml

      - name: Set up Frekvens tools
        run: pip install tools/

      - name: Home thermometer demo
        run: python -m frekvens.HomeThermometerDemo --host localhost --indoor=22 --outdoor=8 2>&1 | grep "httpx.ConnectError"

  x509_crt_bundle:
    name: x509 certificate bundle
    needs: platformio
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - python-version: 3.11
          - python-version: 3.13

    steps:
      - name: Set up Frekvens
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: |
            .github/platformio/requirements.txt
            scripts/requirements.txt

      - name: Set up PlatformIO
        run: pip install -r .github/platformio/requirements.txt

      - name: Set up Cache
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          key: platformio-cache-${{ runner.os }}-${{ runner.arch }}-${{ needs.platformio.outputs.version }}-${{ hashFiles('platformio.ini') }}
          path: |
            .platformio/.cache/downloads
            .platformio/.cache/http

      - name: PlatformIO build
        continue-on-error: true
        run: |
          cat <<EOL > .env
          HOSTNAME='frekvens'
          IKEA_FREKVENS='true'
          MODE_GOOGLEWEATHER='true'
          MODE_OPENMETEO='true'
          MODE_OPENWEATHER='true'
          MODE_WORLDWEATHERONLINE='true'
          MODE_WTTRIN='true'
          MODE_YR='true'
          NAME='Frekvens'
          EOL

          cat <<EOL > firmware/include/config/secrets.h
          #pragma once
          #define GOOGLEWEATHER_KEY "redacted"
          #define LATITUDE "0.000"
          #define LONGITUDE "0.000"
          #define OPENWEATHER_KEY "redacted"
          #define PIN_CS 1
          #define PIN_MOSI 2
          #define PIN_OE 3
          #define PIN_SCLK 4
          #define WIFI_KEY "redacted"
          #define WIFI_SSID "redacted"
          #define WORLDWEATHERONLINE_KEY "redacted"
          EOL

          pio run -e esp32dev

      - name: File existence
        uses: andstor/file-existence-action@076e0072799f4942c8bc574a82233e1e4d13e9d6 # v3.0.0
        with:
          fail: true
          files: firmware/certs/bundle/ca_roots.pem, firmware/embed/x509_crt_bundle.bin

      - name: Set up ESP-IDF
        run: |
          git clone -b release/v5.5 --filter=blob:none --sparse https://github.com/espressif/esp-idf.git && \
          cd esp-idf && \
          git sparse-checkout add components/mbedtls/esp_crt_bundle

      - name: Certificate bundle
        run: |
          python esp-idf/components/mbedtls/esp_crt_bundle/gen_crt_bundle.py --i firmware/certs/bundle && \
          cmp x509_crt_bundle firmware/embed/x509_crt_bundle.bin
